{{ define "main" }}
<div class="auth-container">
  <div class="container">
    <div class="auth-card bg-white mx-auto">
      <div class="auth-header">
        <h1>Reset Password</h1>
        <p>Enter your new password</p>
      </div>

      <div class="auth-error alert alert-danger" id="reset-error" role="alert" aria-live="polite"></div>
      <div class="auth-success alert alert-success" id="reset-success" role="alert" aria-live="polite" style="display: none;"></div>

      <!-- Loading state while verifying token -->
      <div id="reset-loading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Verifying reset link...</p>
      </div>

      <!-- Invalid token state -->
      <div id="reset-invalid" style="display: none;">
        <div class="text-center py-4">
          <p class="text-danger mb-3">This password reset link is invalid or has expired.</p>
          <a href="/forgot/" class="btn btn-primary">Request a new link</a>
        </div>
      </div>

      <!-- Reset form -->
      <form class="auth-form" id="reset-form" onsubmit="handleResetPassword(event)" style="display: none;">
        <div class="mb-3">
          <label for="password" class="form-label">New Password</label>
          <input type="password" class="form-control" id="password" name="password" minlength="8" required aria-required="true">
          <div class="form-text">Must be at least 8 characters</div>
        </div>
        <div class="mb-3">
          <label for="confirmPassword" class="form-label">Confirm Password</label>
          <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" minlength="8" required aria-required="true">
        </div>
        <button type="submit" class="btn btn-primary w-100" id="reset-btn">
          Reset Password
        </button>
      </form>

      <div class="auth-footer">
        <p class="mb-0">Remember your password? <a href="/login/">Sign in</a></p>
      </div>
    </div>
  </div>
</div>

<script>
// Get token from URL
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

// Verify token on page load
async function verifyToken() {
  const loadingEl = document.getElementById('reset-loading');
  const invalidEl = document.getElementById('reset-invalid');
  const formEl = document.getElementById('reset-form');

  if (!token) {
    loadingEl.style.display = 'none';
    invalidEl.style.display = 'block';
    return;
  }

  try {
    const res = await fetch(`/api/auth/verify-reset-token?token=${encodeURIComponent(token)}`);
    const data = await res.json();

    loadingEl.style.display = 'none';

    if (data.valid) {
      formEl.style.display = 'block';
    } else {
      invalidEl.style.display = 'block';
    }
  } catch (err) {
    loadingEl.style.display = 'none';
    invalidEl.style.display = 'block';
  }
}

async function handleResetPassword(e) {
  e.preventDefault();

  const errorEl = document.getElementById('reset-error');
  const successEl = document.getElementById('reset-success');
  const btn = document.getElementById('reset-btn');
  const form = document.getElementById('reset-form');

  errorEl.style.display = 'none';
  successEl.style.display = 'none';

  const password = document.getElementById('password').value;
  const confirmPassword = document.getElementById('confirmPassword').value;

  if (password !== confirmPassword) {
    errorEl.textContent = 'Passwords do not match';
    errorEl.style.display = 'block';
    return;
  }

  if (password.length < 8) {
    errorEl.textContent = 'Password must be at least 8 characters';
    errorEl.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Resetting...';

  try {
    const res = await fetch('/api/auth/reset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, password })
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || 'Something went wrong');
    }

    // Show success and redirect
    form.style.display = 'none';
    successEl.innerHTML = 'Password reset successfully! Redirecting to login...';
    successEl.style.display = 'block';

    setTimeout(() => {
      window.location.href = '/login/';
    }, 2000);
  } catch (err) {
    errorEl.textContent = err.message;
    errorEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Reset Password';
  }
}

// Run verification on page load
verifyToken();
</script>
{{ end }}
